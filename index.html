<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“± Ø¨Ø±Ø§Ù†Ø¯ ÙÙˆÙ†</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0077ff;
      --primary-dark: #0056b3;
      --secondary: #6c757d;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Tajawal", sans-serif;
      display: flex;
      min-height: 100vh;
      background: #f4f6f9;
      color: #333;
    }

    aside {
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      width: 250px;
      min-height: 100vh;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: var(--box-shadow);
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .logo h2 {
      font-size: 20px;
      font-weight: 700;
    }

    .logo i {
      font-size: 24px;
    }

    .nav-item {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 16px;
      padding: 12px 15px;
      text-align: right;
      cursor: pointer;
      border-radius: 8px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255,255,255,0.15);
    }

    .nav-item i {
      width: 20px;
      text-align: center;
    }

    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    section {
      display: none;
      animation: fadeIn 0.5s;
    }

    section.active {
      display: block;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .page-header h1 {
      color: var(--primary);
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: "Tajawal", sans-serif;
      transition: var(--transition);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0,119,255,0.2);
    }

    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-family: "Tajawal", sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: #212529;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 14px;
    }

    .sale-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .invoice-total {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-weight: 700;
      font-size: 18px;
      text-align: center;
    }

    .search-container {
      position: relative;
      margin-bottom: 15px;
    }

    .search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }

    .search-container input {
      padding-left: 40px;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .form-group {
      flex: 1;
    }

    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    th, td {
      padding: 12px 15px;
      text-align: right;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--primary);
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    .low-stock {
      color: var(--danger);
      font-weight: bold;
    }

    /* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ¹ */
    .search-results {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }

    .search-result-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: var(--transition);
    }

    .search-result-item:hover {
      background-color: #f0f8ff;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }


    .invoice-box {
  background: #fff;
  border: 1px solid #eee;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.invoice-box h3 {
  margin: 0 0 8px;
  color: #222;
}

.invoice-box small {
  color: #666;
  display: block;
  margin-bottom: 10px;
}

.items-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}

.items-table th, .items-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
  font-size: 14px;
}

.items-table th {
  background: #f5f5f5;
  font-weight: bold;
}

.total {
  text-align: right;
  font-size: 15px;
  font-weight: bold;
  margin-top: 5px;
}

.invoice-total {
  background: #fafafa;
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 12px;
  margin-top: 20px;
}


    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      aside {
        width: 100%;
        min-height: auto;
        padding: 10px;
      }
      
      .nav-container {
        display: flex;
        overflow-x: auto;
        gap: 5px;
      }
      
      .nav-item {
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .table-container {
        font-size: 14px;
      }
      
      th, td {
        padding: 8px 10px;
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 15px;
      }
      
      .btn {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <aside>
    <div class="logo">
      <i class="fas fa-mobile-alt"></i>
      <h2>Ø¨Ø±Ø§Ù†Ø¯ ÙÙˆÙ†</h2>
    </div>
    
    <div class="nav-container">
      <button class="nav-item active" onclick="showTab('products')">
        <i class="fas fa-boxes"></i>
        <span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
      </button>
      <button class="nav-item" onclick="showTab('sale')">
        <i class="fas fa-cash-register"></i>
        <span>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
      </button>
      <button class="nav-item" onclick="showTab('reports')">
        <i class="fas fa-chart-bar"></i>
        <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
      </button>
    </div>
  </aside>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <main>
    <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <section id="products" class="active">
      <div class="page-header">
        <h1><i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
        <button class="btn btn-primary" onclick="showProductModal()">
          <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
        </button>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-search"></i> Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</h3>
        </div>
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="searchBox" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." oninput="searchProducts()">
        </div>
      </div>
      
      <div class="card">
        <div class="table-container">
          <table id="productsTable">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø§Ù„Ø±Ø¨Ø­</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="productsList">
              <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ -->
    <section id="sale">
      <div class="page-header">
        <h1><i class="fas fa-cash-register"></i> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</h1>
        <button class="btn btn-primary" onclick="printInvoice()">
          <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        </button>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</h3>
        </div>
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="saleSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." oninput="findProductForSale()">
        </div>
        <div id="searchResults" class="search-results"></div>
        <div id="saleProductInfo" class="alert alert-info" style="display:none;"></div>
        <div class="form-row">
          <div class="form-group">
            <input type="number" id="saleQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
          </div>
          <div>
            <button class="btn btn-success" onclick="addToInvoice()">
              <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©
            </button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-receipt"></i> Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
          <button class="btn btn-danger btn-sm" onclick="clearInvoice()">
            <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
          </button>
        </div>
        <div id="invoiceList"></div>
        <div class="invoice-total" id="invoiceTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¬</div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button class="btn btn-primary" onclick="completeSale()" style="flex: 1;">
            <i class="fas fa-check"></i> Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹
          </button>
        </div>
      </div>
    </section>

    <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <section id="reports">
      <div class="page-header">
        <h1><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
        <div>
          <button class="btn btn-primary" onclick="exportReport()">
            <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-shopping-cart"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
          <div>
            <input type="date" id="reportStartDate">
            <span> Ø¥Ù„Ù‰ </span>
            <input type="date" id="reportEndDate">
            <button class="btn btn-primary btn-sm" onclick="getSalesReport()">Ø¹Ø±Ø¶</button>
            <button class="btn btn-success btn-sm" onclick="getTodayReport()">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
          </div>
        </div>
        <div id="salesReport"></div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-boxes"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
        </div>
        <div id="inventoryReport"></div>
      </div>
    </section>
  </main>

  <!-- Firebase & JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, where, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAV5PxtRBw7aamAmSycxI_NdzR7YVgmmSw",
      authDomain: "kasher-os.firebaseapp.com",
      projectId: "kasher-os",
      storageBucket: "kasher-os.firebasestorage.app",
      messagingSenderId: "956040501711",
      appId: "1:956040501711:web:e8eecede32465923e2daba",
      measurementId: "G-XFRPMZVFL7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allProducts = [], selectedProduct = null, invoice = [], total = 0;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      loadProducts();
      
      // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reportStartDate').value = today;
      document.getElementById('reportEndDate').value = today;
    });

    // ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
    window.showTab = (id) => {
      document.querySelectorAll(".nav-item").forEach(b => b.classList.remove("active"));
      document.querySelectorAll("main section").forEach(s => s.classList.remove("active"));
      document.querySelector(`.nav-item[onclick="showTab('${id}')"]`).classList.add("active");
      document.getElementById(id).classList.add("active");
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ù†Ø¯ ÙØªØ­ Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      if (id === 'reports') {
        setTimeout(() => {
          getInventoryReport();
          getTodayReport();
        }, 100);
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
    window.showProductModal = () => {
      const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
      if (!name) return;
      
      const barcode = prompt("Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:");
      if (!barcode) return;
      
      const costPrice = parseFloat(prompt("Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:"));
      if (!costPrice || costPrice <= 0) {
        alert("âš ï¸ Ø§Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡ ØµØ­ÙŠØ­");
        return;
      }
      
      const sellPrice = parseFloat(prompt("Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:"));
      if (!sellPrice || sellPrice <= 0) {
        alert("âš ï¸ Ø§Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹ ØµØ­ÙŠØ­");
        return;
      }
      
      const qty = parseInt(prompt("Ø§Ù„ÙƒÙ…ÙŠØ©:") || 0);
      const category = prompt("Ø§Ù„ÙØ¦Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):") || "Ù‡ÙˆØ§ØªÙ";
      const description = prompt("Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):") || "";
      
      addProductToDB(name, barcode, costPrice, sellPrice, qty, category, description);
    }

    async function addProductToDB(name, barcode, costPrice, sellPrice, qty, category, description) {
      try {
        await addDoc(collection(db, "products"), {
          name, 
          barcode, 
          costPrice, 
          sellPrice, 
          qty, 
          category, 
          description,
          createdAt: new Date(),
          lowStockAlert: qty <= 5
        });
        showAlert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­", "success");
        loadProducts();
      } catch (error) {
        console.error("Error adding product: ", error);
        showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬", "danger");
      }
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬
    window.editProduct = async (id, name, barcode, costPrice, sellPrice, qty, category, description) => {
      const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:", name);
      if (!newName) return;
      
      const newBarcode = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:", barcode);
      if (!newBarcode) return;
      
      const newCostPrice = parseFloat(prompt("ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:", costPrice));
      if (!newCostPrice || newCostPrice <= 0) {
        alert("âš ï¸ Ø§Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡ ØµØ­ÙŠØ­");
        return;
      }
      
      const newSellPrice = parseFloat(prompt("ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:", sellPrice));
      if (!newSellPrice || newSellPrice <= 0) {
        alert("âš ï¸ Ø§Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹ ØµØ­ÙŠØ­");
        return;
      }
      
      const newQty = parseInt(prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©:", qty) || 0);
      const newCategory = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©:", category) || "Ù‡ÙˆØ§ØªÙ";
      const newDescription = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ:", description) || "";
      
      try {
        await updateDoc(doc(db, "products", id), {
          name: newName,
          barcode: newBarcode,
          costPrice: newCostPrice,
          sellPrice: newSellPrice,
          qty: newQty,
          category: newCategory,
          description: newDescription,
          lowStockAlert: newQty <= 5
        });
        showAlert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­", "success");
        loadProducts();
      } catch (error) {
        console.error("Error updating product: ", error);
        showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬", "danger");
      }
    }

    // Ø­Ø°Ù Ù…Ù†ØªØ¬
    window.deleteProduct = async (id) => {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) {
        try {
          await deleteDoc(doc(db, "products", id));
          showAlert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­", "success");
          loadProducts();
        } catch (error) {
          console.error("Error deleting product: ", error);
          showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬", "danger");
        }
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    async function loadProducts() {
      allProducts = [];
      try {
        const snapshot = await getDocs(query(collection(db, "products"), orderBy("createdAt", "desc")));
        snapshot.forEach(docu => {
          allProducts.push({ id: docu.id, ...docu.data() });
        });
        renderProducts(allProducts);
      } catch (error) {
        console.error("Error loading products: ", error);
      }
    }

    function renderProducts(products) {
      const list = document.getElementById("productsList");
      list.innerHTML = "";
      
      if (products.length === 0) {
        list.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">
          <div class="alert alert-info"><i class="fas fa-info-circle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>
        </td></tr>`;
        return;
      }
      
      products.forEach(p => {
        const profit = p.sellPrice - p.costPrice;
        const profitMargin = ((profit / p.costPrice) * 100).toFixed(1);
        const lowStockClass = p.qty <= 5 ? 'class="low-stock"' : '';
        
        list.innerHTML += `
          <tr>
            <td>${p.barcode}</td>
            <td>${p.name}</td>
            <td>${p.costPrice} Ø¬</td>
            <td>${p.sellPrice} Ø¬</td>
            <td ${lowStockClass}>${p.qty}</td>
            <td>${profit} Ø¬ (${profitMargin}%)</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="editProduct('${p.id}', '${p.name}', '${p.barcode}', ${p.costPrice}, ${p.sellPrice}, ${p.qty}, '${p.category}', '${p.description || ''}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>`;
      });
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    window.searchProducts = () => {
      const q = document.getElementById("searchBox").value.toLowerCase();
      const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(q) || 
        p.barcode.includes(q) ||
        p.category.toLowerCase().includes(q)
      );
      renderProducts(filtered);
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ¹
    window.findProductForSale = () => {
      const q = document.getElementById("saleSearch").value.toLowerCase();
      const resultsContainer = document.getElementById("searchResults");
      
      if (q.length < 1) {
        resultsContainer.style.display = "none";
        return;
      }
      
      const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(q) || 
        p.barcode.includes(q)
      );
      
      if (filtered.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        resultsContainer.style.display = "block";
        return;
      }
      
      resultsContainer.innerHTML = "";
      filtered.forEach(product => {
        const item = document.createElement("div");
        item.className = "search-result-item";
        item.innerHTML = `
          <div><strong>${product.name}</strong></div>
          <div>Ø¨Ø§Ø±ÙƒÙˆØ¯: ${product.barcode} | Ø§Ù„Ø³Ø¹Ø±: ${product.sellPrice} Ø¬ | Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${product.qty}</div>
        `;
        item.addEventListener("click", () => {
          selectProductForSale(product);
        });
        resultsContainer.appendChild(item);
      });
      
      resultsContainer.style.display = "block";
    }

    function selectProductForSale(product) {
      selectedProduct = product;
      document.getElementById("saleSearch").value = product.name;
      document.getElementById("searchResults").style.display = "none";
      
      const info = document.getElementById("saleProductInfo");
      info.innerHTML = `<i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ù†ØªØ¬: ${selectedProduct.name} | Ø§Ù„Ø³Ø¹Ø±: ${selectedProduct.sellPrice}Ø¬ | Ù…ØªØ§Ø­: ${selectedProduct.qty}`;
      info.className = "alert alert-success";
      info.style.display = "block";
      document.getElementById("saleQty").focus();
    }

    // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©
    window.addToInvoice = async () => {
      if (!selectedProduct) {
        showAlert("âš ï¸ Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹", "warning");
        return;
      }
      
      const qty = parseInt(document.getElementById("saleQty").value);
      if (!qty || qty <= 0) {
        showAlert("âš ï¸ Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©", "warning");
        return;
      }
      
      if (selectedProduct.qty < qty) {
        showAlert(`âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©. Ø§Ù„Ù…ØªØ§Ø­: ${selectedProduct.qty}`, "warning");
        return;
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©
      const existingItem = invoice.find(item => item.id === selectedProduct.id);
      if (existingItem) {
        existingItem.qty += qty;
        existingItem.total = existingItem.qty * selectedProduct.sellPrice;
      } else {
        invoice.push({
          id: selectedProduct.id,
          name: selectedProduct.name,
          price: selectedProduct.sellPrice,
          qty: qty,
          total: selectedProduct.sellPrice * qty
        });
      }
      
      total = invoice.reduce((sum, item) => sum + item.total, 0);
      renderInvoice();
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
      document.getElementById("saleSearch").value = "";
      document.getElementById("saleQty").value = "1";
      document.getElementById("saleProductInfo").style.display = "none";
      document.getElementById("searchResults").style.display = "none";
      selectedProduct = null;
    }

    function renderInvoice() {
      const list = document.getElementById("invoiceList");
      list.innerHTML = "";
      
      if (invoice.length === 0) {
        list.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©</div>';
        document.getElementById("invoiceTotal").innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¬`;
        return;
      }
      
      invoice.forEach((item, index) => {
        list.innerHTML += `
          <div class="sale-item">
            <div>
              <strong>${item.name}</strong><br>
              <small>${item.qty} Ã— ${item.price} Ø¬</small>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span>${item.total} Ø¬</span>
              <button class="btn btn-danger btn-sm" onclick="removeFromInvoice(${index})">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>`;
      });
      
      document.getElementById("invoiceTotal").innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬`;
    }

    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    window.removeFromInvoice = (index) => {
      total -= invoice[index].total;
      invoice.splice(index, 1);
      renderInvoice();
    }

    // Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    window.clearInvoice = () => {
      if (invoice.length === 0) return;
      
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
        invoice = [];
        total = 0;
        renderInvoice();
      }
    }

    // Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹
    window.completeSale = async () => {
      if (invoice.length === 0) {
        showAlert("âš ï¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©", "warning");
        return;
      }
      
      try {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        for (const item of invoice) {
          const product = allProducts.find(p => p.id === item.id);
          if (product) {
            await updateDoc(doc(db, "products", item.id), {
              qty: product.qty - item.qty,
              lowStockAlert: (product.qty - item.qty) <= 5
            });
          }
        }
        
        // Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹
        await addDoc(collection(db, "sales"), {
          items: invoice,
          total: total,
          date: new Date()
        });
        
        showAlert("âœ… ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­", "success");
        invoice = [];
        total = 0;
        renderInvoice();
        loadProducts();
      } catch (error) {
        console.error("Error completing sale: ", error);
        showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹", "danger");
      }
    }

    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    window.printInvoice = () => {
      if (invoice.length === 0) {
        showAlert("âš ï¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©", "warning");
        return;
      }
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html dir="rtl">
          <head>
            <title>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              .header { text-align: center; margin-bottom: 20px; }
              .item { display: flex; justify-content: space-between; margin-bottom: 10px; }
              .total { font-weight: bold; margin-top: 20px; text-align: center; }
              .footer { margin-top: 30px; text-align: center; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h2>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h2>
              <p>${new Date().toLocaleString('ar-EG')}</p>
            </div>
            <div class="items">
              ${invoice.map(item => `
                <div class="item">
                  <span>${item.name} (${item.qty} Ã— ${item.price} Ø¬)</span>
                  <span>${item.total} Ø¬</span>
                </div>
              `).join('')}
            </div>
            <div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬</div>
            <div class="footer">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…</div>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    window.getSalesReport = async () => {
      const startDate = document.getElementById("reportStartDate").value;
      const endDate = document.getElementById("reportEndDate").value;
      
      if (!startDate || !endDate) {
        showAlert("âš ï¸ Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©", "warning");
        return;
      }
      
      try {
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        
        const salesQuery = query(
          collection(db, "sales"),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "desc")
        );
        
        const snapshot = await getDocs(salesQuery);
        const report = document.getElementById("salesReport");
        report.innerHTML = "";
        
        if (snapshot.empty) {
          report.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®</div>';
          return;
        }
        
        let totalSales = 0;
        let salesCount = 0;
        
        snapshot.forEach(doc => {
          const sale = doc.data();
          totalSales += sale.total;
          salesCount++;
          
          report.innerHTML += `
            <div class="sale-item">
              <div>
                <strong>ÙØ§ØªÙˆØ±Ø© #${doc.id.substring(0, 8)}</strong><br>
                <small>${sale.date.toDate().toLocaleString('ar-EG')}</small><br>
                <small>${sale.items.length} Ù…Ù†ØªØ¬</small>
              </div>
              <div>${sale.total} Ø¬</div>
            </div>`;
        });
        
        report.innerHTML += `
          <div class="invoice-total">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSales} Ø¬</div>
            <div>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${salesCount}</div>
            <div>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${(totalSales / salesCount).toFixed(2)} Ø¬</div>
          </div>`;
      } catch (error) {
        console.error("Error getting sales report: ", error);
        showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", "danger");
      }
    }

    // ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…
window.getTodayReport = async () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  
  try {
    const salesQuery = query(
      collection(db, "sales"),
      where("date", ">=", today),
      where("date", "<", tomorrow),
      orderBy("date", "desc")
    );
    
    const snapshot = await getDocs(salesQuery);
    const report = document.getElementById("salesReport");
    report.innerHTML = "";
    
    if (snapshot.empty) {
      report.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>';
      return;
    }
    
    let totalSales = 0;
    let salesCount = 0;
    
// ğŸ§¾ Ø´ÙƒÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„
snapshot.forEach(doc => {
  const sale = doc.data();
  totalSales += sale.total;
  salesCount++;
  
  // ğŸ›’ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  let itemsHTML = `
    <table class="items-table">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  sale.items.forEach(item => {
    itemsHTML += `
      <tr>
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>${item.price} Ø¬</td>
        <td>${item.qty * item.price} Ø¬</td>
      </tr>
    `;
  });
  
  itemsHTML += `</tbody></table>`;

  // ØµÙ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  report.innerHTML += `
    <div class="invoice-box">
      <h3>ÙØ§ØªÙˆØ±Ø© #${doc.id.substring(0, 8)}</h3>
      <small>${sale.date.toDate().toLocaleString('ar-EG')}</small>
      ${itemsHTML}
      <div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>${sale.total} Ø¬</strong></div>
    </div>
  `;
});

// Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
report.innerHTML += `
  <div class="invoice-total">
    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: ${totalSales} Ø¬</div>
    <div>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${salesCount}</div>
    <div>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${(totalSales / salesCount).toFixed(2)} Ø¬</div>
  </div>`;

  } catch (error) {
    console.error("Error getting today's report: ", error);
    showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…", "danger");
  }
}


    // ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    window.getInventoryReport = async () => {
      const inventoryReport = document.getElementById("inventoryReport");
      inventoryReport.innerHTML = "";
      
      if (allProducts.length === 0) {
        inventoryReport.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>';
        return;
      }
      
      let totalValue = 0;
      let lowStockCount = 0;
      
      allProducts.forEach(p => {
        const productValue = p.costPrice * p.qty;
        totalValue += productValue;
        
        if (p.qty <= 5) {
          lowStockCount++;
        }
        
        inventoryReport.innerHTML += `
          <div class="sale-item">
            <div>
              <strong>${p.name}</strong><br>
              <small>Ø¨Ø§Ø±ÙƒÙˆØ¯: ${p.barcode} | Ø§Ù„ÙØ¦Ø©: ${p.category}</small>
            </div>
            <div>
              <span>${p.qty} ÙˆØ­Ø¯Ø©</span><br>
              <small>${productValue} Ø¬</small>
            </div>
          </div>`;
      });
      
      inventoryReport.innerHTML += `
        <div class="invoice-total">
          <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${totalValue} Ø¬</div>
          <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${lowStockCount}</div>
        </div>`;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function showAlert(message, type) {
      const alert = document.createElement("div");
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i> ${message}`;
      
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    window.exportReport = () => {
      showAlert("â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØªØµØ¯ÙŠØ±...", "info");
      setTimeout(() => {
        showAlert("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­", "success");
      }, 2000);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#saleSearch') && !e.target.closest('#searchResults')) {
        document.getElementById('searchResults').style.display = 'none';
      }
    });
  </script>
</body>
</html>
